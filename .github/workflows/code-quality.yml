name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Code formatting and linting
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      run: |
        # Manual Rust installation with retry logic
        echo "Installing Rust toolchain with retry logic..."
        
        # Try multiple installation methods
        for method in 1 2 3; do
          echo "Trying installation method $method..."
        
          case $method in
            1)
              # Method 1: Using curl with rustup-init
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            2)
              # Method 2: Using wget with rustup-init
              wget -O rustup-init.sh https://sh.rustup.rs
              chmod +x rustup-init.sh
              ./rustup-init.sh -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            3)
              # Method 3: Using the official action as last resort
              echo "Trying official action as last resort..."
              # This will be handled by the next step if this fails
              ;;
          esac
        
          # Check if installation was successful
          if command -v rustc &> /dev/null; then
            echo "Rust installation successful with method $method"
            break
          fi
        
          echo "Method $method failed, waiting 30 seconds before next attempt..."
          sleep 30
        done
        
        # Add to PATH
        source $HOME/.cargo/env
        
        # Verify installation
        rustc --version
        cargo --version
        rustfmt --version
        cargo clippy --version
        
        # If still not installed, try the official action as last resort
        if ! command -v rustc &> /dev/null; then
          echo "Manual installation failed, trying official action..."
          # This will be handled by the next step
        fi

    - name: Install Rust toolchain (Fallback)
      if: failure()
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy
        timeout-minutes: 30


    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2

    - name: Check code formatting
      run: cargo fmt --all -- --check

    - name: Check clippy warnings
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Check for unused dependencies
      run: cargo check --all-targets --all-features

  # Code complexity analysis
  complexity:
    name: Code Complexity
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      run: |
        # Manual Rust installation with retry logic
        echo "Installing Rust toolchain with retry logic..."
        
        # Try multiple installation methods
        for method in 1 2 3; do
          echo "Trying installation method $method..."
        
          case $method in
            1)
              # Method 1: Using curl with rustup-init
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            2)
              # Method 2: Using wget with rustup-init
              wget -O rustup-init.sh https://sh.rustup.rs
              chmod +x rustup-init.sh
              ./rustup-init.sh -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            3)
              # Method 3: Using the official action as last resort
              echo "Trying official action as last resort..."
              # This will be handled by the next step if this fails
              ;;
          esac
        
          # Check if installation was successful
          if command -v rustc &> /dev/null; then
            echo "Rust installation successful with method $method"
            break
          fi
        
          echo "Method $method failed, waiting 30 seconds before next attempt..."
          sleep 30
        done
        
        # Add to PATH
        source $HOME/.cargo/env
        
        # Verify installation
        rustc --version
        cargo --version
        rustfmt --version
        cargo clippy --version
        
        # If still not installed, try the official action as last resort
        if ! command -v rustc &> /dev/null; then
          echo "Manual installation failed, trying official action..."
          # This will be handled by the next step
        fi

    - name: Install Rust toolchain (Fallback)
      if: failure()
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy
        timeout-minutes: 30


    - name: Install cargo-tarpaulin for code coverage
      run: cargo install cargo-tarpaulin

    - name: Run code coverage
      run: cargo tarpaulin --out Xml --output-dir coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Security and dependency analysis
  security:
    name: Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      run: |
        # Manual Rust installation with retry logic
        echo "Installing Rust toolchain with retry logic..."
        
        # Try multiple installation methods
        for method in 1 2 3; do
          echo "Trying installation method $method..."
        
          case $method in
            1)
              # Method 1: Using curl with rustup-init
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            2)
              # Method 2: Using wget with rustup-init
              wget -O rustup-init.sh https://sh.rustup.rs
              chmod +x rustup-init.sh
              ./rustup-init.sh -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            3)
              # Method 3: Using the official action as last resort
              echo "Trying official action as last resort..."
              # This will be handled by the next step if this fails
              ;;
          esac
        
          # Check if installation was successful
          if command -v rustc &> /dev/null; then
            echo "Rust installation successful with method $method"
            break
          fi
        
          echo "Method $method failed, waiting 30 seconds before next attempt..."
          sleep 30
        done
        
        # Add to PATH
        source $HOME/.cargo/env
        
        # Verify installation
        rustc --version
        cargo --version
        rustfmt --version
        cargo clippy --version
        
        # If still not installed, try the official action as last resort
        if ! command -v rustc &> /dev/null; then
          echo "Manual installation failed, trying official action..."
          # This will be handled by the next step
        fi

    - name: Install Rust toolchain (Fallback)
      if: failure()
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy
        timeout-minutes: 30

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run cargo audit
      run: cargo audit

    - name: Run cargo deny
      run: |
        cargo install cargo-deny
        cargo deny check

    - name: Check for outdated dependencies
      run: |
        cargo install cargo-outdated
        cargo outdated || echo "Some dependencies are outdated"

  # Documentation checks
  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      run: |
        # Manual Rust installation with retry logic
        echo "Installing Rust toolchain with retry logic..."
        
        # Try multiple installation methods
        for method in 1 2 3; do
          echo "Trying installation method $method..."
        
          case $method in
            1)
              # Method 1: Using curl with rustup-init
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            2)
              # Method 2: Using wget with rustup-init
              wget -O rustup-init.sh https://sh.rustup.rs
              chmod +x rustup-init.sh
              ./rustup-init.sh -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            3)
              # Method 3: Using the official action as last resort
              echo "Trying official action as last resort..."
              # This will be handled by the next step if this fails
              ;;
          esac
        
          # Check if installation was successful
          if command -v rustc &> /dev/null; then
            echo "Rust installation successful with method $method"
            break
          fi
        
          echo "Method $method failed, waiting 30 seconds before next attempt..."
          sleep 30
        done
        
        # Add to PATH
        source $HOME/.cargo/env
        
        # Verify installation
        rustc --version
        cargo --version
        rustfmt --version
        cargo clippy --version
        
        # If still not installed, try the official action as last resort
        if ! command -v rustc &> /dev/null; then
          echo "Manual installation failed, trying official action..."
          # This will be handled by the next step
        fi

    - name: Install Rust toolchain (Fallback)
      if: failure()
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy
        timeout-minutes: 30

    - name: Check documentation
      run: |
        # Check that all public APIs are documented
        cargo doc --no-deps --document-private-items
        
        # Check for broken links in documentation
        cargo install cargo-deadlinks
        cargo deadlinks

    - name: Check README
      run: |
        # Check if README exists and has content
        if [ ! -f "README.md" ]; then
          echo "README.md is missing"
          exit 1
        fi
        
        # Check README length
        lines=$(wc -l < README.md)
        if [ "$lines" -lt 50 ]; then
          echo "README.md seems too short ($lines lines)"
          exit 1
        fi

  # Performance regression testing
  performance:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      run: |
        # Manual Rust installation with retry logic
        echo "Installing Rust toolchain with retry logic..."
        
        # Try multiple installation methods
        for method in 1 2 3; do
          echo "Trying installation method $method..."
        
          case $method in
            1)
              # Method 1: Using curl with rustup-init
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            2)
              # Method 2: Using wget with rustup-init
              wget -O rustup-init.sh https://sh.rustup.rs
              chmod +x rustup-init.sh
              ./rustup-init.sh -y --default-toolchain stable --component rustfmt --component clippy --no-modify-path
              ;;
            3)
              # Method 3: Using the official action as last resort
              echo "Trying official action as last resort..."
              # This will be handled by the next step if this fails
              ;;
          esac
        
          # Check if installation was successful
          if command -v rustc &> /dev/null; then
            echo "Rust installation successful with method $method"
            break
          fi
        
          echo "Method $method failed, waiting 30 seconds before next attempt..."
          sleep 30
        done
        
        # Add to PATH
        source $HOME/.cargo/env
        
        # Verify installation
        rustc --version
        cargo --version
        rustfmt --version
        cargo clippy --version
        
        # If still not installed, try the official action as last resort
        if ! command -v rustc &> /dev/null; then
          echo "Manual installation failed, trying official action..."
          # This will be handled by the next step
        fi

    - name: Install Rust toolchain (Fallback)
      if: failure()
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy
        timeout-minutes: 30

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev sqlite3

    - name: Generate test certificates
      run: |
        mkdir -p certs
        openssl req -x509 -newkey rsa:4096 -keyout certs/client.key -out certs/client.crt -days 365 -nodes -subj "/CN=test-client"
        openssl req -x509 -newkey rsa:4096 -keyout certs/ca.key -out certs/ca.crt -days 365 -nodes -subj "/CN=test-ca"
        chmod 600 certs/*.key

    - name: Run performance tests
      run: |
        # Run performance tests with timing
        time cargo test --test performance_test -- --nocapture
        
        # Check build time
        time cargo build --release

    - name: Check binary size
      run: |
        cargo build --release
        echo "Binary size:"
        ls -lh target/release/mtls-proxy
